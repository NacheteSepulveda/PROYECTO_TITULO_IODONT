{% extends "base.html" %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <title>Horarios Disponibles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="{% static 'css/calendario_est.css' %}" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/es.js'></script>
</head>
<body>
    <!-- Bloque para mostrar mensajes de Django -->
    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="container">
        <div class="sidebar">
            <h2>Perfil</h2>
            <a href="{% url 'infoestudiante' %}">Modificar Perfil</a>
            <h2>Mis Pacientes</h2>
            <a href="{% url 'pacientes_est' %}">Ver Pacientes</a>
            <h2>Notificaciones</h2>
            <a href="{% url 'notificaciones' %}">Ver Notificaciones</a>
            <h2>Mi Calendario</h2>
            <a href="{% url 'calendario' %}">Organizar horarios</a>
        </div>
    
        <div class="content flex-grow-1 p-4" id="horario">
            <!-- Asegúrate de que el formulario englobe todo lo necesario -->
            <form method="POST" class="form-publicar-horario" id="horarioForm">
                {% csrf_token %}
                <!-- Campos de selección arriba -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.tipoTratamiento.label_tag }}
                            {{ form.tipoTratamiento }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.inicio.label_tag }}
                            {{ form.inicio }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.fin.label_tag }}
                            {{ form.fin }}
                        </div>
                    </div>
                </div>

                <!-- Campo oculto para las fechas seleccionadas -->
                <input type="hidden" name="fecha_seleccionada" id="fecha_seleccionada">

                <div class="row">
                    <div class="col-12">
                        <h3>Mi Calendario</h3>
                        <div id='calendar' class="mb-4"></div>
                        <div class="d-flex gap-2 mb-4 justify-content-start">
                            <button type="button" class="btn btn-secondary" id="clearButton">
                                Limpiar Selección
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Publicar Horarios
                            </button>
                        </div>

                        <h3>Horarios Disponibles</h3>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filtroHora" class="form-label">Filtrar por Hora</label>
                                    <select class="form-select" id="filtroHora">
                                        <option value="">Todas las horas</option>
                                        {% for horario in horarios_disponibles|dictsort:"inicio" %}
                                            <option value="{{ horario.inicio|time:'H:i' }}">{{ horario.inicio|time:"H:i" }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filtroTratamiento" class="form-label">Filtrar por Tratamiento</label>
                                    <select class="form-select" id="filtroTratamiento">
                                        <option value="">Todos los tratamientos</option>
                                        {% for horario in horarios_disponibles %}
                                            <option value="{{ horario.tipoTratamiento.nombreTratamiento }}">
                                                {{ horario.tipoTratamiento.nombreTratamiento }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filtroEstado" class="form-label">Filtrar por Estado</label>
                                    <select class="form-select" id="filtroEstado">
                                        <option value="">Todos los estados</option>
                                        <option value="Disponible">Disponible</option>
                                        <option value="Reservado">Reservado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        {% if horarios_disponibles %}
                            <div class="table-responsive">
                                <table class="table table-striped" id="tablaHorarios">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Hora Inicio</th>
                                            <th>Hora Fin</th>
                                            <th>Tratamiento</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for horario in horarios_disponibles %}
                                        <tr>
                                            <td>{{ horario.fecha_seleccionada|date:"d/m/Y" }}</td>
                                            <td>{{ horario.inicio|time:"H:i" }}</td>
                                            <td>{{ horario.fin|time:"H:i" }}</td>
                                            <td>{{ horario.tipoTratamiento.nombreTratamiento }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if horario.paciente %}
                                                        <div class="d-inline-flex align-items-center">
                                                            <span class="badge bg-warning me-2">Reservado</span>
                                                            <span class="text-secondary" style="font-size: 1em;">
                                                                por <span class="fw-bold text-dark">{{ horario.paciente.first_name }} {{ horario.paciente.last_name }}</span>
                                                            </span>
                                                        </div>
                                                    {% else %}
                                                        <span class="badge bg-info">Disponible</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if horario.estudiante == request.user %}
                                                    <a href="{% url 'eliminar_horario' horario_id=horario.id %}" 
                                                       class="btn btn-danger btn-sm">
                                                        Eliminar
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                No hay horarios disponibles.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var selectedDates = new Set();
            
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                dateClick: function(info) {
                    var clickedDate = info.dateStr;
                    if (selectedDates.has(clickedDate)) {
                        selectedDates.delete(clickedDate);
                        info.dayEl.style.backgroundColor = '';
                    } else {
                        selectedDates.add(clickedDate);
                        info.dayEl.style.backgroundColor = '#93c47d';
                    }
                    updateHiddenField();
                },
                validRange: function(nowDate) {
                    return {
                        start: nowDate
                    };
                },
                firstDay: 1,
                weekNumbers: false,
                fixedWeekCount: false,
                showNonCurrentDates: false,
                unselectAuto: false
            });

            calendar.render();

            function updateHiddenField() {
                var sortedDates = Array.from(selectedDates).sort();
                document.getElementById('fecha_seleccionada').value = sortedDates.join(',');
                console.log('Fechas seleccionadas:', sortedDates);
            }

            // Botón de limpiar
            document.getElementById('clearButton').onclick = function(e) {
                e.preventDefault();
                selectedDates.clear();
                calendar.el.querySelectorAll('.fc-day').forEach(cell => {
                    cell.style.backgroundColor = '';
                });
                updateHiddenField();
            };

            // Validación del formulario
            document.getElementById('horarioForm').addEventListener('submit', function(e) {
                if (!document.getElementById('fecha_seleccionada').value) {
                    e.preventDefault();
                    alert('Por favor, selecciona al menos una fecha en el calendario');
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filtroHora = document.getElementById('filtroHora');
            const filtroTratamiento = document.getElementById('filtroTratamiento');
            const filtroEstado = document.getElementById('filtroEstado');
            const tabla = document.getElementById('tablaHorarios');
        
            // Eliminar opciones duplicadas en los selectores
            function eliminarDuplicados(selector) {
                const opciones = new Set();
                const options = Array.from(selector.options);
                
                options.forEach(option => {
                    if (option.value !== '') {  // Mantener la opción "Todos"
                        opciones.add(option.value);
                    }
                });
                
                // Limpiar y reconstruir el selector
                while (selector.options.length > 1) {  // Mantener solo la primera opción ("Todos")
                    selector.remove(1);
                }
                
                // Agregar opciones únicas ordenadas
                Array.from(opciones).sort().forEach(valor => {
                    const option = new Option(valor, valor);
                    selector.add(option);
                });
            }
        
            // Eliminar duplicados en los selectores
            eliminarDuplicados(filtroHora);
            eliminarDuplicados(filtroTratamiento);
        
            function filtrarTabla() {
                const hora = filtroHora.value.toLowerCase();
                const tratamiento = filtroTratamiento.value.toLowerCase();
                const estado = filtroEstado.value.toLowerCase();
        
                const filas = tabla.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
                for (let fila of filas) {
                    const horaInicio = fila.cells[1].textContent.toLowerCase();
                    const tratamientoTexto = fila.cells[3].textContent.toLowerCase();
                    const estadoTexto = fila.cells[4].textContent.toLowerCase();
        
                    const coincideHora = !hora || horaInicio.includes(hora);
                    const coincideTratamiento = !tratamiento || tratamientoTexto.includes(tratamiento);
                    const coincideEstado = !estado || estadoTexto.includes(estado);
        
                    if (coincideHora && coincideTratamiento && coincideEstado) {
                        fila.style.display = '';
                    } else {
                        fila.style.display = 'none';
                    }
                }
            }
        
            // Agregar event listeners a los filtros
            filtroHora.addEventListener('change', filtrarTabla);
            filtroTratamiento.addEventListener('change', filtrarTabla);
            filtroEstado.addEventListener('change', filtrarTabla);
        });
        </script>

    <!-- Bootstrap Bundle con Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/your-code.js" crossorigin="anonymous"></script>
</body>
</html>
{% endblock %}