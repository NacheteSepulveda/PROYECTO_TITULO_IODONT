{% extends "base.html" %}
{% block content %}
{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <title>Horarios Disponibles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="{% static 'css/calendario_est.css' %}" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
</head>
<body>

    <!-- Bloque para mostrar mensajes de Django -->
    {% if messages %}
    <div class="alert-container">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
    </div>
    {% endif %}
    
    <div class="container"> <!-- Contenedor flexible -->
        <div class="sidebar">
            <h2>Perfil</h2>
            <a href="{% url 'infoestudiante' %}">Modificar Perfil</a>
            <h2>Mis Pacientes</h2>
            <a href="{% url 'pacientes_est' %}">Ver Pacientes</a>
            <h2>Notificaciones</h2>
            <a href="{% url 'notificaciones' %}">Ver Notificaciones</a>
            <h2>Mi Calendario</h2>
            <a href="{% url 'calendario' %}">Organizar horarios</a>
        </div>
    
        <div class="content flex-grow-1 p-4" id="horario"> <!-- Contenido principal -->
            <!-- Bloque para mostrar mensajes de Django -->
            {% if messages %}
            <div class="alert-container">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
    
            <h3>Horarios Disponibles</h3>
            {% if horarios_disponibles %}
                <ul class="list-unstyled">
                    {% for horario in horarios_disponibles %}
                        <li class="mb-2">
                            Fecha: {{ horario.fecha_seleccionada }} - Hora: {{ horario.inicio }} - Tratamiento: {{ horario.tipoTratamiento.nombreTratamiento }}
                            {% if horario.estudiante == request.user %}
                                <a href="{% url 'eliminar_horario' horario.id %}" class="btn btn-danger btn-sm">Eliminar</a>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No hay horarios disponibles.</p>
            {% endif %}
    
            <h3>Publicar un Nuevo Horario</h3>
                
            <p><strong>Estudiante:</strong> {{ user.first_name }} {{ user.last_name }}</p>
            <form method="POST" class="form-publicar-horario">
                {% csrf_token %}
                <!-- Mostrar el campo de tipo de tratamiento -->
                <div class="form-group">
                    {{ form.tipoTratamiento.label_tag }}
                    {{ form.tipoTratamiento }}
                </div>

                <!-- Mostrar el campo de hora de inicio -->
                <div class="form-group">
                    {{ form.inicio.label_tag }}
                    {{ form.inicio }}
                </div>

                <!-- Campo oculto de fecha que se actualizará con el calendario -->
                <div class="form-group" style="display: none;">
                    {{ form.fecha_seleccionada }}
                </div>

                <!-- Campo oculto del estudiante -->
                {{ form.estudiante }}
                <br>
                <!-- Calendario -->
                <div id="calendar">

                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var calendarEl = document.getElementById('calendar');
                            var fechaInput = document.getElementById('id_fecha_seleccionada');
                            var fechasSeleccionadas = new Set(); // Para almacenar múltiples fechas
                            
                            var calendar = new FullCalendar.Calendar(calendarEl, {
                                initialView: 'dayGridMonth',
                                headerToolbar: {
                                    left: 'prev,next today',
                                    center: 'title',
                                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                                },
                                buttonText: {
                                    today: 'Hoy',
                                    month: 'Mes',
                                    week: 'Semana',
                                    day: 'Día'
                                },
                                locale: 'es',
                                selectable: true,
                                selectMirror: true,
                                dayMaxEvents: true,
                                navLinks: true,
                                editable: true,
                                firstDay: 1,
                                select: function(info) {
                                    // Añadir la fecha al conjunto de fechas seleccionadas
                                    fechasSeleccionadas.add(info.startStr);
                                    
                                    // Actualizar el campo oculto con todas las fechas
                                    if (fechaInput) {
                                        fechaInput.value = Array.from(fechasSeleccionadas).join(',');
                                    }

                                    // Marcar visualmente el día seleccionado
                                    calendar.addEvent({
                                        start: info.startStr,
                                        end: info.endStr,
                                        display: 'background',
                                        color: '#007bff'
                                    });
                                },
                                dateClick: function(info) {
                                    // Alternar la selección al hacer clic en un día
                                    if (fechasSeleccionadas.has(info.dateStr)) {
                                        // Si ya está seleccionada, quitarla
                                        fechasSeleccionadas.delete(info.dateStr);
                                        // Eliminar el evento visual
                                        calendar.getEvents().forEach(function(event) {
                                            if (event.startStr === info.dateStr) {
                                                event.remove();
                                            }
                                        });
                                    } else {
                                        // Si no está seleccionada, añadirla
                                        fechasSeleccionadas.add(info.dateStr);
                                        // Añadir evento visual
                                        calendar.addEvent({
                                            start: info.dateStr,
                                            display: 'background',
                                            color: '#007bff'
                                        });
                                    }
                                    
                                    // Actualizar el campo oculto
                                    if (fechaInput) {
                                        fechaInput.value = Array.from(fechasSeleccionadas).join(',');
                                    }
                                }
                            });
                            
                            calendar.render();
                        });
                    </script>

                </div>

                <br>   
                <button type="submit" class="btn btn-primary">Publicar Horario</button>
            </form>
        </div>
    </div>
    {% endblock %}
</body>
</html>

