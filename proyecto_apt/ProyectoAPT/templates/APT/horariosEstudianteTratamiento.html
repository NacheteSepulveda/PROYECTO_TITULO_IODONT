{% extends "base.html" %}
{% block content %}
{% load crispy_forms_tags %}
{% load static %}

<link type="text/css" rel="stylesheet" href='{% static "css/agenda_cita.css" %}'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<main class="container">
    <!-- Bloque para mostrar mensajes -->
    {% if messages %}
        <div>
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="servicios-container">
        <h2 class="titulo-principal">¿QUÉ SERVICIO NECESITA AGENDAR?</h2>
        <p class="subtitulo">Elige el servicio que necesitas agendar</p>
        
        <form action="" method="post">
            {% csrf_token %}
            <div class="servicios-grid">
                {% for tratamiento in estudiante.obtenerTratamiento %}
                    <div class="servicio-card">
                        <div class="icono">
                            <i class="fas fa-tooth"></i>
                        </div>
                        <h3>{{ tratamiento.nombreTratamiento }}</h3>
                        <p>Servicio dental profesional</p>
                        <a
                            class="btn-servicio"
                            name="tratamiento"
                            id="id_tratamiento_{{ tratamiento.id }}"
                            role="button"
                            data-bs-toggle="modal" 
                            data-bs-target="#modalTratamiento"
                            data-tratamiento-id="{{ tratamiento.id }}"
                            data-tratamiento-nombre="{{ tratamiento.nombreTratamiento }}"
                        >Seleccionar</a>
                    </div>
                {% endfor %}
            </div>

            <div class="row" id="hiddenValues">
                {{ form.tratamiento }} 
                <input type="hidden" name="tipotratamiento" id="nombreTratamiento" value="">
                <input type="text" name="paciente" id="id_paciente" hidden value="{{ actualUser }}">
                <input type="hidden" name="estudiante" id="id_estudiante" hidden value="{{ estudiante.id }}">
            </div>

            <!-- Modal -->
            <div class="modal fade" id="modalTratamiento" tabindex="-1" aria-labelledby="modalTratamientoLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="modalTratamientoLabel">Selección de Horario</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h3 id="tratamientoNombre"></h3>

                            <div class="form-group">
                                <label for="id_fecha_seleccionada">{{ form.fecha_seleccionada.label }}</label>
                                {{ form.fecha_seleccionada }}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_HorIni">Horarios Disponibles</label>
                                <select id="id_HorIni" name="inicio" class="form-select">
                                    <option value="">Seleccione una hora</option>
                                </select>
                                <div id="no-horarios-message" style="display:none; color: red;">
                                    No Hay Horarios Disponibles
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Agendar</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
// El mismo JavaScript que tenías antes
document.addEventListener('DOMContentLoaded', function() {
    var modalTratamiento = document.getElementById('modalTratamiento');
    var tratamientoInput = document.getElementById('nombreTratamiento');
    var horariosSelect = document.getElementById('id_HorIni');
    var fechaSeleccionadaInput = document.getElementById('id_fecha_seleccionada');
    var noHorariosMessage = document.getElementById('no-horarios-message');
    var estudianteInput = document.getElementById('id_estudiante');

    modalTratamiento.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var tratamientoId = button.getAttribute('data-tratamiento-id');
        var tratamientoNombre = button.getAttribute('data-tratamiento-nombre');

        tratamientoInput.value = tratamientoId;
        document.getElementById('tratamientoNombre').textContent = tratamientoNombre;

        fechaSeleccionadaInput.addEventListener('change', function () {
            var fechaSeleccionada = this.value;

            if (tratamientoId && fechaSeleccionada) {
                fetch(`/obtener-horarios-disponibles/?tratamiento_id=${tratamientoId}&fecha_seleccionada=${fechaSeleccionada}&estudiante_id=${estudianteInput.value}`)
                .then(response => response.json())
                .then(data => {
                    horariosSelect.innerHTML = '';
                    if (data.length > 0) {
                        noHorariosMessage.style.display = 'none';
                        data.forEach(function(horario) {
                            var option = document.createElement('option');
                            option.value = horario.inicio;
                            option.text = horario.inicio;
                            horariosSelect.appendChild(option);
                        });
                    } else {
                        horariosSelect.innerHTML = '';
                        noHorariosMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Hubo un problema con la petición Fetch:', error);
                });
            }
        });
    });
});
</script>
{% endblock %}